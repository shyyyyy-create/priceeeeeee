import React, { useState, useEffect, useMemo } from 'react';
import { Plus, Search, Trash2, Edit3, Save, Download, Upload, ShoppingCart, ChevronRight, History, Calculator } from 'lucide-react';

// --- 常數定義：分類數據 ---
const CATEGORIES = {
  '護膚品': ['化妝水', '精華', '乳液/面霜', '防曬', '潔面', '卸妝'],
  '化妝品Base': ['妝前', '氣墊', '粉底', '遮瑕', '腮紅', '光/陰影'],
  '化妝品Eyes': ['眉筆', '眼線/臥蠶', '眼影', '睫毛膏'],
  '化妝品Lip': ['唇線筆', '唇釉', '唇膏'],
  '其他': ['手部膚理', '身體護理', '香水', '零食', '生活雜貨']
};

// --- 退稅計算邏輯 ---
const calculateRefund = (total) => {
  if (total < 15000) return 0;
  const tiers = [
    { limit: 30000, refund: 1000 }, { limit: 50000, refund: 2000 }, { limit: 75000, refund: 3000 },
    { limit: 100000, refund: 5000 }, { limit: 125000, refund: 7000 }, { limit: 150000, refund: 8000 },
    { limit: 175000, refund: 9000 }, { limit: 200000, refund: 10000 }, { limit: 225000, refund: 12000 },
    { limit: 250000, refund: 13000 }, { limit: 275000, refund: 15000 }, { limit: 300000, refund: 17000 },
    { limit: 325000, refund: 19000 }, { limit: 350000, refund: 21000 }, { limit: 375000, refund: 23000 },
    { limit: 400000, refund: 25000 }, { limit: 425000, refund: 27000 }, { limit: 450000, refund: 28000 },
    { limit: 475000, refund: 30000 }, { limit: 500000, refund: 32000 }, { limit: 550000, refund: 35000 },
    { limit: 600000, refund: 37000 }, { limit: 650000, refund: 41000 }
  ];
  const tier = tiers.find(t => total < t.limit);
  return tier ? tier.refund : 41000;
};

export default function OliveYoungApp() {
  const [activeTab, setActiveTab] = useState('inventory'); // 導覽切換
  const [products, setProducts] = useState([]);
  const [plans, setPlans] = useState([]);
  
  // --- 持久化緩存 ---
  useEffect(() => {
    const savedProducts = localStorage.getItem('oy_products');
    const savedPlans = localStorage.getItem('oy_plans');
    if (savedProducts) setProducts(JSON.parse(savedProducts));
    if (savedPlans) setPlans(JSON.parse(savedPlans));
  }, []);

  useEffect(() => {
    localStorage.setItem('oy_products', JSON.stringify(products));
    localStorage.setItem('oy_plans', JSON.stringify(plans));
  }, [products, plans]);

  // --- 匯出/匯入功能 ---
  const exportData = () => {
    const data = JSON.stringify({ products, plans });
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `olive_young_backup_${new Date().toISOString().slice(0,10)}.json`;
    link.click();
  };

  const importData = (e) => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = (event) => {
      const { products: p, plans: pl } = JSON.parse(event.target.result);
      setProducts(p); setPlans(pl);
    };
    reader.readAsText(file);
  };

  return (
    <div className="min-h-screen bg-gray-50 pb-20 font-sans text-gray-900">
      {/* 頂部導覽列 */}
      <header className="sticky top-0 z-50 bg-white border-b px-4 py-3 flex justify-between items-center shadow-sm">
        <h1 className="text-xl font-bold text-green-600">Olive Young Tracker</h1>
        <div className="flex gap-2">
          <button onClick={exportData} className="p-2 bg-gray-100 rounded-full"><Download size={20}/></button>
          <label className="p-2 bg-gray-100 rounded-full cursor-pointer">
            <Upload size={20}/><input type="file" hidden onChange={importData}/>
          </label>
        </div>
      </header>

      <main className="max-w-md mx-auto p-4">
        {activeTab === 'register' && <RegistrationPage products={products} setProducts={setProducts} />}
        {activeTab === 'inventory' && <InventoryPage products={products} setProducts={setProducts} plans={plans} setPlans={setPlans} />}
        {activeTab === 'plans' && <PlansPage plans={plans} setPlans={setPlans} />}
        {activeTab === 'calc' && <QuickCalcPage products={products} />}
      </main>

      {/* 底部導覽列 - 避免遮擋 */}
      <nav className="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around py-3 shadow-lg z-50">
        <NavBtn active={activeTab === 'register'} label="登記" onClick={() => setActiveTab('register')} icon={<Plus size={20}/>}/>
        <NavBtn active={activeTab === 'inventory'} label="庫存" onClick={() => setActiveTab('inventory')} icon={<Search size={20}/>}/>
        <NavBtn active={activeTab === 'plans'} label="計劃" onClick={() => setActiveTab('plans')} icon={<ShoppingCart size={20}/>}/>
        <NavBtn active={activeTab === 'calc'} label="速算" onClick={() => setActiveTab('calc')} icon={<Calculator size={20}/>}/>
      </nav>
    </div>
  );
}

// --- 分頁組件 (登記頁) ---
function RegistrationPage({ products, setProducts }) {
  const [form, setForm] = useState({ 
    name: '', img: '', link: '', mainCat: '護膚品', subCat: '化妝水', 
    specs: [{ name: '默認規格', originalPrice: '', specialPrice: '', specialStart: '', specialEnd: '', couponPrice: '', couponStart: '', couponEnd: '', dailyPrice: '', dailyStart: '', dailyEnd: '' }]
  });

  const addSpec = () => setForm({...form, specs: [...form.specs, { name: '', originalPrice: '' }]});

  const saveProduct = () => {
    setProducts([...products, { ...form, id: Date.now(), status: '未收藏' }]);
    alert('產品已登記！');
  };

  return (
    <div className="space-y-4">
      <h2 className="text-lg font-bold">產品登記</h2>
      <div className="bg-white p-4 rounded-xl shadow-sm space-y-3">
        <input placeholder="產品名稱" className="w-full border p-2 rounded" onChange={e => setForm({...form, name: e.target.value})}/>
        <input placeholder="圖片 Link" className="w-full border p-2 rounded" onChange={e => setForm({...form, img: e.target.value})}/>
        
        <div className="flex gap-2 overflow-x-auto pb-2">
          {Object.keys(CATEGORIES).map(cat => (
            <button key={cat} onClick={() => setForm({...form, mainCat: cat, subCat: CATEGORIES[cat][0]})} 
              className={`px-3 py-1 rounded-full whitespace-nowrap ${form.mainCat === cat ? 'bg-green-500 text-white' : 'bg-gray-200'}`}>{cat}</button>
          ))}
        </div>
        <div className="flex gap-2 overflow-x-auto pb-2 border-t pt-2">
          {CATEGORIES[form.mainCat].map(sub => (
            <button key={sub} onClick={() => setForm({...form, subCat: sub})} 
              className={`px-3 py-1 rounded-full whitespace-nowrap text-sm ${form.subCat === sub ? 'bg-blue-500 text-white' : 'bg-gray-100'}`}>{sub}</button>
          ))}
        </div>

        {form.specs.map((spec, idx) => (
          <div key={idx} className="border-t pt-2 mt-2 space-y-2">
            <input placeholder="規格 (如: 50ml)" className="w-full border p-2 rounded text-sm" onChange={e => {
              const newSpecs = [...form.specs]; newSpecs[idx].name = e.target.value; setForm({...form, specs: newSpecs});
            }}/>
            <div className="grid grid-cols-2 gap-2">
              <input type="number" placeholder="原價" className="border p-2 rounded text-sm" onChange={e => {
                const newSpecs = [...form.specs]; newSpecs[idx].originalPrice = e.target.value; setForm({...form, specs: newSpecs});
              }}/>
              <input type="number" placeholder="特價" className="border p-2 rounded text-sm" />
            </div>
          </div>
        ))}
        <button onClick={addSpec} className="w-full py-2 border-dashed border-2 text-gray-500 rounded">+ 增加規格</button>
        <button onClick={saveProduct} className="w-full py-3 bg-green-600 text-white rounded-xl font-bold">儲存產品</button>
      </div>
    </div>
  );
}

// --- 分頁組件 (產品庫頁 - 簡化示意) ---
function InventoryPage({ products, setProducts, plans, setPlans }) {
  const [search, setSearch] = useState('');
  const [filter, setFilter] = useState('全部');

  const filtered = products.filter(p => p.name.includes(search) && (filter === '全部' || p.mainCat === filter));

  return (
    <div className="space-y-4">
      <div className="flex gap-2 bg-white p-2 rounded-lg border shadow-sm">
        <Search className="text-gray-400" />
        <input className="w-full outline-none" placeholder="搜尋產品..." onChange={e => setSearch(e.target.value)}/>
      </div>

      <div className="flex gap-2 overflow-x-auto no-scrollbar">
        {['全部', '護膚品', '化妝品Base', '想買', '需要', '必買'].map(f => (
          <button key={f} onClick={() => setFilter(f)} className={`px-4 py-1 rounded-full border ${filter === f ? 'bg-black text-white' : 'bg-white'}`}>{f}</button>
        ))}
      </div>

      <div className="grid grid-cols-1 gap-4">
        {filtered.map(p => (
          <div key={p.id} className="bg-white p-3 rounded-xl shadow-sm border relative">
            <div className="flex gap-3">
              <div className="w-20 h-20 bg-gray-100 rounded-md overflow-hidden">
                <img src={p.img || 'https://via.placeholder.com/150'} alt={p.name} className="object-cover w-full h-full" />
              </div>
              <div className="flex-1">
                <h3 className="font-bold text-sm leading-tight">{p.name}</h3>
                <p className="text-xs text-gray-500 mt-1">{p.mainCat} > {p.subCat}</p>
                <div className="flex gap-1 mt-2">
                   <button className="text-[10px] px-2 py-0.5 border rounded-full bg-orange-50 text-orange-600">想買</button>
                   <button className="text-[10px] px-2 py-0.5 border rounded-full bg-red-50 text-red-600">必買</button>
                </div>
              </div>
            </div>
            <div className="mt-3 flex justify-between items-center border-t pt-2">
              <span className="text-sm font-bold text-green-700">₩{p.specs[0]?.originalPrice || 0}</span>
              <button className="text-xs bg-blue-500 text-white px-3 py-1 rounded-lg">加入計劃</button>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

// --- 分頁組件 (計劃頁) ---
function PlansPage({ plans, setPlans }) {
  const [activePlanIdx, setActivePlanIdx] = useState(null);

  const addNewPlan = () => {
    const name = prompt('計劃名稱？');
    if (name) setPlans([...plans, { name, items: [] }]);
  };

  return (
    <div className="space-y-4">
      <div className="flex justify-between items-center">
        <h2 className="text-lg font-bold">我的購物計劃</h2>
        <button onClick={addNewPlan} className="bg-green-600 text-white p-2 rounded-full"><Plus size={18}/></button>
      </div>

      {plans.length === 0 && <p className="text-center text-gray-400 py-10">暫無計劃，快去新增吧！</p>}

      {plans.map((plan, idx) => (
        <div key={idx} className="bg-white p-4 rounded-xl shadow-sm border">
          <div className="flex justify-between items-center mb-2">
            <h3 className="font-bold text-lg">{plan.name}</h3>
            <div className="flex gap-2">
              <Edit3 size={16} className="text-gray-400"/>
              <Trash2 size={16} className="text-red-400" onClick={() => {
                const n = [...plans]; n.splice(idx,1); setPlans(n);
              }}/>
            </div>
          </div>
          <div className="text-sm text-gray-600 space-y-1">
            <div className="flex justify-between"><span>預計總額:</span><span>₩0</span></div>
            <div className="flex justify-between font-bold text-blue-600"><span>退稅金額:</span><span>₩0</span></div>
          </div>
        </div>
      ))}
    </div>
  );
}

// --- 分頁組件 (速算頁) ---
function QuickCalcPage({ products }) {
  const [tempItems, setTempItems] = useState([]);
  const [total, setTotal] = useState(0);

  const refund = useMemo(() => calculateRefund(total), [total]);

  return (
    <div className="space-y-4">
      <div className="bg-gradient-to-br from-green-500 to-green-700 p-6 rounded-2xl text-white shadow-lg">
        <p className="opacity-80 text-sm">實付總額 (退稅後)</p>
        <h2 className="text-3xl font-black">₩{(total - refund).toLocaleString()}</h2>
        <div className="flex justify-between mt-4 text-xs bg-white/20 p-2 rounded-lg">
          <span>總價: ₩{total.toLocaleString()}</span>
          <span>退稅: ₩{refund.toLocaleString()}</span>
        </div>
      </div>

      <div className="bg-white p-4 rounded-xl shadow-sm border space-y-3">
        <h3 className="font-bold border-b pb-2">快速計算清單</h3>
        <div className="min-h-[100px] flex flex-col gap-2">
           <p className="text-center text-gray-400 text-sm py-4">請從產品庫加入或手動輸入...</p>
        </div>
        <button className="w-full py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-medium">+ 手動增加臨時品項</button>
      </div>
    </div>
  );
}

// --- 小組件 ---
function NavBtn({ active, label, icon, onClick }) {
  return (
    <button onClick={onClick} className={`flex flex-col items-center gap-1 ${active ? 'text-green-600' : 'text-gray-400'}`}>
      {icon}
      <span className="text-[10px] font-bold">{label}</span>
    </button>
  );
}
