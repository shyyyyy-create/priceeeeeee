<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>美妝購物比價助手</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .pill-active { @apply bg-indigo-600 text-white shadow-md; }
        .pill-inactive { @apply bg-gray-100 text-gray-600 hover:bg-gray-200; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans">
    <div id="app" v-cloak class="max-w-4xl mx-auto pb-20">
        
        <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-gray-200 px-4 py-3 mb-6">
            <div class="flex justify-around items-center overflow-x-auto no-scrollbar gap-2">
                <button v-for="tab in tabs" :key="tab.id" 
                    @click="currentTab = tab.id"
                    :class="['px-4 py-2 rounded-full text-sm font-medium transition-all whitespace-nowrap', 
                    currentTab === tab.id ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'text-gray-500 hover:bg-gray-100']">
                    <i :class="['mr-1', tab.icon]"></i> {{ tab.name }}
                </button>
            </div>
        </nav>

        <main class="px-4">
            
            <section v-if="currentTab === 'register'" class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                <h2 class="text-xl font-bold text-gray-800 mb-6 border-l-4 border-indigo-500 pl-3">新增商品登記</h2>
                
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-sm font-semibold text-gray-600">商品名稱</label>
                            <input v-model="newProd.name" type="text" placeholder="例如：SK-II 神仙水" class="w-full border-gray-200 border rounded-xl px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                        <div class="space-y-1">
                            <label class="text-sm font-semibold text-gray-600">分類</label>
                            <div class="flex flex-wrap gap-2">
                                <button v-for="cat in categories" @click="newProd.category = cat" 
                                    :class="['px-3 py-1 text-xs rounded-full border transition', newProd.category === cat ? 'bg-indigo-50 border-indigo-500 text-indigo-600' : 'border-gray-200 text-gray-500']">
                                    {{ cat }}
                                </button>
                            </div>
                        </div>
                    </div>

                    <div v-if="subCategories[newProd.category]" class="space-y-2">
                        <label class="text-sm font-semibold text-gray-600">子分類</label>
                        <div class="flex flex-wrap gap-2">
                            <button v-for="sub in subCategories[newProd.category]" @click="newProd.subCategory = sub"
                                :class="['px-3 py-1 text-xs rounded-full border transition', newProd.subCategory === sub ? 'bg-pink-50 border-pink-500 text-pink-600' : 'border-gray-200 text-gray-500']">
                                {{ sub }}
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input v-model="newProd.link" placeholder="商品 URL" class="text-sm border-gray-200 border rounded-xl px-4 py-2">
                        <input v-model="newProd.img" placeholder="圖片 URL" class="text-sm border-gray-200 border rounded-xl px-4 py-2">
                    </div>

                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label class="text-sm font-semibold text-gray-600">商品規格</label>
                            <button @click="addSpec" class="text-indigo-600 text-xs font-bold">+ 增加規格</button>
                        </div>
                        <div v-for="(spec, index) in newProd.specs" :key="index" class="flex gap-2 mb-2">
                            <input v-model="newProd.specs[index]" placeholder="規格 (如: 230ml)" class="flex-1 text-sm border-gray-200 border rounded-xl px-4 py-2">
                            <button @click="removeSpec(index)" class="text-red-400 px-2"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>

                    <hr class="border-gray-100">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div>
                                <label class="text-sm font-semibold text-gray-600">原價</label>
                                <input v-model.number="newProd.originalPrice" type="number" class="w-full border-gray-200 border rounded-xl px-4 py-2">
                            </div>
                            <div class="bg-orange-50 p-4 rounded-xl border border-orange-100">
                                <label class="text-sm font-semibold text-orange-700">特價設定</label>
                                <input v-model.number="newProd.salePrice" type="number" placeholder="特價金額" class="w-full mt-1 border-orange-200 border rounded-lg px-3 py-1.5 text-sm">
                                <div class="grid grid-cols-2 gap-2 mt-2">
                                    <input v-model="newProd.saleStart" type="date" class="text-xs border-orange-200 border rounded px-2 py-1">
                                    <input v-model="newProd.saleEnd" type="date" class="text-xs border-orange-200 border rounded px-2 py-1">
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" v-model="newProd.hasCoupon" class="w-4 h-4 text-blue-600">
                                    <span class="text-sm font-semibold text-blue-700">使用優惠券</span>
                                </label>
                                <div v-if="newProd.hasCoupon" class="mt-2 space-y-2">
                                    <input v-model.number="newProd.couponPrice" type="number" placeholder="券後價格" class="w-full border-blue-200 border rounded-lg px-3 py-1.5 text-sm">
                                    <div class="grid grid-cols-2 gap-2">
                                        <input v-model="newProd.couponStart" type="date" class="text-xs border-blue-200 border rounded px-2 py-1">
                                        <input v-model="newProd.couponEnd" type="date" class="text-xs border-blue-200 border rounded px-2 py-1">
                                    </div>
                                </div>
                            </div>

                            <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" v-model="newProd.isTodaySpecial" class="w-4 h-4 text-purple-600">
                                    <span class="text-sm font-semibold text-purple-700">今天特優</span>
                                </label>
                                <div v-if="newProd.isTodaySpecial" class="mt-2 space-y-2">
                                    <input v-model.number="newProd.todayPrice" type="number" placeholder="特優價格" class="w-full border-purple-200 border rounded-lg px-3 py-1.5 text-sm">
                                    <div class="grid grid-cols-2 gap-2">
                                        <input v-model="newProd.todayStart" type="date" class="text-xs border-purple-200 border rounded px-2 py-1">
                                        <input v-model="newProd.todayEnd" type="date" class="text-xs border-purple-200 border rounded px-2 py-1">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button @click="saveProduct" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition">
                        儲存商品
                    </button>
                </div>
            </section>

            <section v-if="currentTab === 'list'" class="space-y-4">
                <div class="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm mb-4">
                    <input v-model="searchQuery" type="text" placeholder="搜尋商品名稱..." class="text-sm bg-gray-50 border-none rounded-lg px-4 py-2 w-full">
                </div>

                <div v-for="p in filteredProducts" :key="p.id" class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 flex gap-4">
                    <img :src="p.img || 'https://via.placeholder.com/100'" class="w-24 h-24 object-cover rounded-xl bg-gray-50">
                    <div class="flex-1">
                        <div class="flex justify-between">
                            <h3 class="font-bold text-gray-800">{{ p.name }}</h3>
                            <div class="space-x-2">
                                <button @click="editProduct(p)" class="text-blue-500 text-sm"><i class="fas fa-edit"></i></button>
                                <button @click="deleteProduct(p.id)" class="text-red-400 text-sm"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">{{ p.category }} > {{ p.subCategory }}</p>
                        <div class="flex flex-wrap gap-1 mt-1">
                            <span v-for="s in p.specs" class="bg-gray-100 text-[10px] px-2 py-0.5 rounded text-gray-500">{{ s }}</span>
                        </div>
                        <div class="mt-2 flex items-baseline gap-2">
                            <span class="text-indigo-600 font-bold">₩{{ getBestPrice(p) }}</span>
                            <span class="text-xs text-gray-400 line-through">₩{{ p.originalPrice }}</span>
                        </div>
                        <div class="text-[10px] text-orange-500 mt-1" v-if="p.saleEnd">
                            優惠期至: {{ p.saleEnd }}
                        </div>
                    </div>
                </div>
            </section>

            <section v-if="currentTab === 'plan'" class="space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold">我的購物清單</h2>
                    <button @click="createNewList" class="bg-indigo-100 text-indigo-700 px-4 py-2 rounded-full text-xs font-bold">+ 新清單</button>
                </div>

                <div v-for="(list, lIdx) in planLists" :key="lIdx" class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                    <div class="flex justify-between items-center mb-4">
                        <input v-model="list.name" class="font-bold text-lg border-b-2 border-transparent focus:border-indigo-200 outline-none">
                        <button @click="removeList(lIdx)" class="text-gray-300 hover:text-red-500"><i class="fas fa-times-circle"></i></button>
                    </div>

                    <div v-for="(item, iIdx) in list.items" :key="iIdx" class="flex items-center gap-3 py-3 border-b border-gray-50 last:border-0">
                        <div class="flex-1">
                            <p class="font-medium text-gray-700">{{ item.name }}</p>
                            <p class="text-xs text-gray-400">₩{{ item.price }} / {{ item.spec }}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <input v-model.number="item.qty" type="number" class="w-12 text-center bg-gray-50 rounded border text-sm">
                            <button @click="list.items.splice(iIdx, 1)" class="text-red-300"><i class="fas fa-minus-circle"></i></button>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-dashed border-gray-200 flex justify-between items-center">
                        <span class="text-gray-500 font-medium">總計額：</span>
                        <span class="text-xl font-bold text-indigo-600">₩{{ calculateListTotal(list) }}</span>
                    </div>
                </div>
            </section>

            <section v-if="currentTab === 'tax'" class="bg-white rounded-2xl shadow-sm p-6">
                <h2 class="text-xl font-bold mb-4">韓國退稅額對照表</h2>
                <div class="grid grid-cols-1 gap-1 h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                    <div v-for="t in taxTable" class="flex justify-between py-2 px-4 rounded-lg bg-gray-50 mb-1 text-sm">
                        <span class="text-gray-600">{{ t.min.toLocaleString() }} ~ {{ t.max ? t.max.toLocaleString() : '以上' }}</span>
                        <span class="font-bold text-indigo-600">₩{{ t.refund.toLocaleString() }}</span>
                    </div>
                </div>
            </section>

            <section v-if="currentTab === 'calc'" class="space-y-4">
                <div class="bg-indigo-600 rounded-2xl p-6 text-white shadow-lg">
                    <p class="text-indigo-100 text-sm">速算總金額 (含退稅)</p>
                    <div class="text-3xl font-bold mt-1">₩{{ (calcTotal - currentRefund).toLocaleString() }}</div>
                    <div class="flex justify-between mt-4 text-xs opacity-80">
                        <span>總計: ₩{{ calcTotal.toLocaleString() }}</span>
                        <span>退稅額: -₩{{ currentRefund.toLocaleString() }}</span>
                    </div>
                </div>

                <div class="relative">
                    <input v-model="calcSearch" placeholder="搜尋已登記商品加入..." class="w-full rounded-xl px-4 py-3 shadow-sm border-none">
                    <div v-if="calcSearch && searchResults.length" class="absolute z-10 w-full bg-white mt-1 shadow-xl rounded-xl border border-gray-100 max-h-60 overflow-y-auto">
                        <div v-for="p in searchResults" @click="addToCalc(p)" class="p-3 hover:bg-indigo-50 cursor-pointer border-b border-gray-50 last:border-0">
                            <p class="font-bold text-sm">{{ p.name }}</p>
                            <p class="text-[10px] text-gray-400">₩{{ getBestPrice(p) }}</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-4 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold">計算清單</h3>
                        <button @click="addManualToCalc" class="text-xs bg-gray-100 px-3 py-1 rounded-full">+ 手動新增項目</button>
                    </div>
                    <div v-for="(item, idx) in calcList" :key="idx" class="flex items-center gap-3 py-3 border-b border-gray-50 last:border-0">
                        <div class="flex-1">
                            <input v-model="item.name" class="font-medium text-gray-700 w-full bg-transparent border-none focus:ring-0 p-0">
                            <div class="flex gap-2 mt-1">
                                <input v-model.number="item.price" type="number" class="text-xs text-indigo-600 bg-gray-50 px-2 py-0.5 rounded w-20">
                                <select v-if="item.specs" v-model="item.selectedSpec" class="text-[10px] bg-gray-50 border-none rounded">
                                    <option v-for="s in item.specs" :value="s">{{ s }}</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input v-model.number="item.qty" type="number" class="w-10 text-center text-sm font-bold">
                            <button @click="calcList.splice(idx, 1)" class="text-red-300"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <script>
        const { createApp, ref, reactive, computed, watch } = Vue;

        createApp({
            setup() {
                const currentTab = ref('register');
                const searchQuery = ref('');
                const calcSearch = ref('');
                
                const tabs = [
                    { id: 'register', name: '登記', icon: 'fas fa-plus-circle' },
                    { id: 'list', name: '已登記', icon: 'fas fa-th-list' },
                    { id: 'plan', name: '計劃', icon: 'fas fa-shopping-basket' },
                    { id: 'calc', name: '速算', icon: 'fas fa-calculator' },
                    { id: 'tax', name: '退稅', icon: 'fas fa-receipt' }
                ];

                const categories = ['護膚品', '化妝品Base', '化妝品Eyes', '化妝品Lip', '其他'];
                const subCategories = {
                    '護膚品': ['化妝水', '精華', '乳液/面霜', '防曬', '潔面', '卸妝'],
                    '化妝品Base': ['妝前', '氣墊', '粉底', '遮瑕', '腮紅', '光/陰影'],
                    '化妝品Eyes': ['眉筆', '眼線/臥蠶', '眼影', '睫毛膏'],
                    '化妝品Lip': ['唇線筆', '唇釉', '唇膏'],
                    '其他': ['手部膚理', '身體護理', '香水', '零食', '生活雜貨']
                };

                const taxTable = [
                    {min: 15000, max: 29999, refund: 1000},
                    {min: 30000, max: 49999, refund: 2000},
                    {min: 50000, max: 74999, refund: 3000},
                    {min: 75000, max: 99999, refund: 5000},
                    {min: 100000, max: 124999, refund: 7000},
                    {min: 125000, max: 149999, refund: 8000},
                    {min: 150000, max: 174999, refund: 9000},
                    {min: 175000, max: 199999, refund: 10000},
                    {min: 200000, max: 224999, refund: 12000},
                    {min: 225000, max: 249999, refund: 13000},
                    {min: 250000, max: 274999, refund: 15000},
                    {min: 275000, max: 299999, refund: 17000},
                    {min: 300000, max: 324999, refund: 19000},
                    {min: 325000, max: 349999, refund: 21000},
                    {min: 350000, max: 374999, refund: 23000},
                    {min: 375000, max: 399999, refund: 25000},
                    {min: 400000, max: 424999, refund: 27000},
                    {min: 425000, max: 449999, refund: 28000},
                    {min: 450000, max: 474999, refund: 30000},
                    {min: 475000, max: 499999, refund: 32000},
                    {min: 500000, max: 549999, refund: 35000},
                    {min: 550000, max: 599999, refund: 37000},
                    {min: 600000, max: 649999, refund: 41000},
                ];

                // 資料持久化
                const products = ref(JSON.parse(localStorage.getItem('products') || '[]'));
                const planLists = ref(JSON.parse(localStorage.getItem('planLists') || '[{"name": "首爾行程清單", "items": []}]'));
                const calcList = ref([]);

                const newProd = reactive({
                    id: null, name: '', category: '護膚品', subCategory: '', link: '', img: '',
                    specs: [''], originalPrice: 0, salePrice: null, saleStart: '', saleEnd: '',
                    hasCoupon: false, couponPrice: null, couponStart: '', couponEnd: '',
                    isTodaySpecial: false, todayPrice: null, todayStart: '', todayEnd: ''
                });

                // 方法
                const addSpec = () => newProd.specs.push('');
                const removeSpec = (idx) => newProd.specs.splice(idx, 1);

                const saveProduct = () => {
                    if(!newProd.name) return alert('請輸入商品名稱');
                    const data = {...newProd, id: newProd.id || Date.now()};
                    const idx = products.value.findIndex(p => p.id === data.id);
                    if(idx > -1) products.value[idx] = data;
                    else products.value.push(data);
                    
                    localStorage.setItem('products', JSON.stringify(products.value));
                    resetNewProd();
                    currentTab.value = 'list';
                };

                const resetNewProd = () => {
                    Object.assign(newProd, {
                        id: null, name: '', category: '護膚品', subCategory: '', link: '', img: '',
                        specs: [''], originalPrice: 0, salePrice: null, saleStart: '', saleEnd: '',
                        hasCoupon: false, couponPrice: null, couponStart: '', couponEnd: '',
                        isTodaySpecial: false, todayPrice: null, todayStart: '', todayEnd: ''
                    });
                };

                const getBestPrice = (p) => {
                    let prices = [p.originalPrice];
                    if(p.salePrice) prices.push(p.salePrice);
                    if(p.hasCoupon && p.couponPrice) prices.push(p.couponPrice);
                    if(p.isTodaySpecial && p.todayPrice) prices.push(p.todayPrice);
                    return Math.min(...prices);
                };

                const filteredProducts = computed(() => {
                    return products.value.filter(p => p.name.toLowerCase().includes(searchQuery.value.toLowerCase()));
                });

                const deleteProduct = (id) => {
                    if(confirm('確定刪除？')) {
                        products.value = products.value.filter(p => p.id !== id);
                        localStorage.setItem('products', JSON.stringify(products.value));
                    }
                };

                const editProduct = (p) => {
                    Object.assign(newProd, JSON.parse(JSON.stringify(p)));
                    currentTab.value = 'register';
                };

                const createNewList = () => {
                    planLists.value.push({name: '新清單', items: []});
                };

                const calculateListTotal = (list) => {
                    return list.items.reduce((sum, item) => sum + (item.price * item.qty), 0);
                };

                const searchResults = computed(() => {
                    if(!calcSearch.value) return [];
                    return products.value.filter(p => p.name.toLowerCase().includes(calcSearch.value.toLowerCase()));
                });

                const addToCalc = (p) => {
                    calcList.value.push({
                        name: p.name,
                        price: getBestPrice(p),
                        qty: 1,
                        specs: p.specs,
                        selectedSpec: p.specs[0]
                    });
                    calcSearch.value = '';
                };

                const addManualToCalc = () => {
                    calcList.value.push({ name: '新項目', price: 0, qty: 1 });
                };

                const calcTotal = computed(() => {
                    return calcList.value.reduce((sum, item) => sum + (item.price * item.qty), 0);
                });

                const currentRefund = computed(() => {
                    const total = calcTotal.value;
                    const tier = [...taxTable].reverse().find(t => total >= t.min);
                    return tier ? tier.refund : 0;
                });

                // 監聽存檔
                watch(planLists, (val) => localStorage.setItem('planLists', JSON.stringify(val)), {deep: true});

                return {
                    currentTab, tabs, categories, subCategories, newProd, products, 
                    searchQuery, filteredProducts, planLists, taxTable,
                    calcSearch, searchResults, calcList, calcTotal, currentRefund,
                    addSpec, removeSpec, saveProduct, deleteProduct, editProduct, getBestPrice,
                    createNewList, calculateListTotal, addToCalc, addManualToCalc
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
