<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>美妝價格追蹤器 - 韓國購物助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .filter-clip { @apply px-3 py-1 rounded-full border text-sm transition-all cursor-pointer whitespace-nowrap; }
        .filter-clip.active { @apply bg-pink-500 text-white border-pink-500; }
        .card { @apply bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-4; }
        .tab-btn { @apply flex-1 py-3 text-center text-sm font-medium border-b-2 transition-all; }
        .tab-active { @apply border-pink-500 text-pink-600; }
        .input-field { @apply w-full border border-gray-200 rounded-lg px-3 py-2 mt-1 focus:ring-2 focus:ring-pink-200 focus:outline-none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

<div id="app" class="max-w-md mx-auto min-h-screen pb-24 relative bg-white shadow-lg">
    <header class="bg-pink-500 text-white p-4 sticky top-0 z-50 flex justify-between items-center">
        <h1 class="text-xl font-bold">Price History Pro</h1>
        <div class="space-x-2">
            <button @click="exportData" class="text-xs bg-pink-600 px-2 py-1 rounded"><i class="fas fa-download"></i></button>
            <label class="text-xs bg-pink-600 px-2 py-1 rounded cursor-pointer">
                <i class="fas fa-upload"></i>
                <input type="file" @change="importData" class="hidden">
            </label>
        </div>
    </header>

    <nav class="flex border-b bg-white sticky top-14 z-40">
        <button v-for="t in tabs" :key="t.id" @click="currentTab = t.id" 
                :class="['tab-btn', currentTab === t.id ? 'tab-active' : 'text-gray-500 border-transparent']">
            <i :class="t.icon" class="block mb-1 text-lg"></i>
            {{ t.name }}
        </button>
    </nav>

    <main class="p-4">
        <section v-if="currentTab === 'register'">
            <h2 class="font-bold mb-4 text-gray-700">新增產品</h2>
            <div class="card">
                <label>產品名稱</label>
                <input v-model="form.name" type="text" class="input-field" placeholder="例如：Innisfree 綠茶精華">
                
                <div class="mt-3">
                    <label>圖片 & 產品連結</label>
                    <input v-model="form.img" type="text" class="input-field mb-2" placeholder="圖片網址">
                    <input v-model="form.link" type="text" class="input-field" placeholder="購買連結">
                </div>

                <div class="mt-3">
                    <label>產品分類</label>
                    <div class="flex flex-wrap gap-2 mt-2">
                        <span v-for="(cat, key) in categories" :key="key" 
                              @click="form.category = key; form.subCategory = ''"
                              :class="['filter-clip', form.category === key ? 'active' : 'bg-gray-100']">
                            {{ key }}
                        </span>
                    </div>
                    <div v-if="form.category" class="flex flex-wrap gap-2 mt-2 p-2 bg-pink-50 rounded-lg">
                        <span v-for="sub in categories[form.category]" :key="sub"
                              @click="form.subCategory = sub"
                              :class="['filter-clip text-xs', form.subCategory === sub ? 'active' : 'bg-white']">
                            {{ sub }}
                        </span>
                    </div>
                </div>

                <div class="mt-4 border-t pt-4">
                    <div class="flex justify-between items-center mb-2">
                        <label class="font-bold">產品規格</label>
                        <button @click="addSpec" class="text-pink-500 text-sm">+ 增加規格</button>
                    </div>
                    <div v-for="(spec, index) in form.specs" :key="index" class="bg-gray-50 p-3 rounded-lg mb-3 border">
                        <input v-model="spec.name" placeholder="規格名稱 (如: 50ml, #21色)" class="input-field text-sm">
                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <input v-model.number="spec.originalPrice" type="number" placeholder="原價" class="input-field text-sm">
                            <input v-model.number="spec.salePrice" type="number" placeholder="特價" class="input-field text-sm">
                        </div>
                        <div class="mt-2 text-xs text-gray-500">特價期間</div>
                        <div class="grid grid-cols-2 gap-2 mt-1">
                            <input v-model="spec.saleStart" type="date" class="input-field text-xs">
                            <input v-model="spec.saleEnd" type="date" class="input-field text-xs">
                        </div>
                    </div>
                </div>
                <button @click="saveProduct" class="w-full bg-pink-500 text-white py-3 rounded-xl mt-4 font-bold">儲存產品</button>
            </div>
        </section>

        <section v-if="currentTab === 'library'">
            <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                <span v-for="tag in ['想買', '需要', '必買', '未收藏']" :key="tag"
                      @click="toggleFilter(tag)"
                      :class="['filter-clip', libraryFilter === tag ? 'active' : 'bg-white']">{{ tag }}</span>
            </div>
            <input v-model="searchQuery" type="text" class="input-field mb-4" placeholder="搜尋產品名稱...">

            <div v-for="prod in filteredProducts" :key="prod.id" class="card">
                <div class="flex gap-3">
                    <img :src="prod.img || 'https://via.placeholder.com/80'" class="w-20 h-20 object-cover rounded-lg">
                    <div class="flex-1">
                        <h3 class="font-bold">{{ prod.name }}</h3>
                        <p class="text-xs text-gray-400">{{ prod.category }} > {{ prod.subCategory }}</p>
                        <div class="mt-2 flex gap-1">
                            <button @click="updateTag(prod, '想買')" :class="['text-[10px] px-2 py-1 rounded', prod.tag === '想買' ? 'bg-orange-500 text-white' : 'bg-gray-100']">想買</button>
                            <button @click="updateTag(prod, '需要')" :class="['text-[10px] px-2 py-1 rounded', prod.tag === '需要' ? 'bg-blue-500 text-white' : 'bg-gray-100']">需要</button>
                            <button @click="updateTag(prod, '必買')" :class="['text-[10px] px-2 py-1 rounded', prod.tag === '必買' ? 'bg-red-500 text-white' : 'bg-gray-100']">必買</button>
                        </div>
                    </div>
                    <button @click="deleteProduct(prod.id)" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                </div>

                <div class="mt-3 bg-gray-50 rounded-lg p-2">
                    <div v-for="spec in prod.specs" :key="spec.id" class="border-b last:border-0 py-2">
                        <div class="flex justify-between items-start">
                            <span class="text-sm font-medium">{{ spec.name }}</span>
                            <div class="text-right">
                                <div class="text-xs text-gray-400 line-through">₩{{ spec.originalPrice }}</div>
                                <div class="text-sm font-bold text-pink-500">₩{{ spec.salePrice }}</div>
                            </div>
                        </div>
                        <div class="flex justify-between mt-2">
                            <button @click="showHistory(prod, spec)" class="text-[10px] text-blue-500">歷史價格</button>
                            <button @click="openPlanModal(prod, spec)" class="bg-pink-100 text-pink-600 px-2 py-1 rounded text-xs">+ 計畫</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section v-if="currentTab === 'plan'">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold">我的採購清單</h2>
                <button @click="addPlan" class="bg-pink-500 text-white px-3 py-1 rounded-lg text-sm">+ 新計畫</button>
            </div>

            <div v-for="plan in plans" :key="plan.id" class="card">
                <div class="flex justify-between items-center mb-3">
                    <input v-model="plan.name" class="font-bold border-none p-0 focus:ring-0">
                    <button @click="deletePlan(plan.id)" class="text-gray-400"><i class="fas fa-times"></i></button>
                </div>
                
                <div v-for="item in plan.items" :key="item.id" class="flex justify-between items-center py-2 border-b border-dashed">
                    <div class="text-sm">
                        <div class="font-medium">{{ item.prodName }}</div>
                        <div class="text-xs text-gray-400">{{ item.specName }}</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="flex items-center border rounded">
                            <button @click="item.qty > 1 ? item.qty-- : null" class="px-2 border-r">-</button>
                            <span class="px-3 text-sm">{{ item.qty }}</span>
                            <button @click="item.qty++" class="px-2 border-l">+</button>
                        </div>
                        <div class="text-right min-w-[80px]">
                            <div class="text-sm font-bold">₩{{ item.price * item.qty }}</div>
                        </div>
                    </div>
                </div>

                <div class="mt-4 bg-pink-50 p-3 rounded-lg text-sm space-y-1">
                    <div class="flex justify-between"><span>合計金額:</span><span>₩{{ calculatePlanTotal(plan).total }}</span></div>
                    <div class="flex justify-between text-blue-600"><span>韓國退稅:</span><span>- ₩{{ calculatePlanTotal(plan).tax }}</span></div>
                    <div class="flex justify-between font-bold text-lg pt-2 border-t"><span>實付金額:</span><span>₩{{ calculatePlanTotal(plan).final }}</span></div>
                </div>
            </div>
        </section>

        <section v-if="currentTab === 'quick'">
            <div class="card bg-gray-800 text-white">
                <h2 class="text-center text-xl font-bold mb-2">快速合計</h2>
                <div class="flex justify-between text-sm mb-1"><span>總價:</span><span>₩{{ quickCalcTotal.total }}</span></div>
                <div class="flex justify-between text-sm mb-1"><span>退稅:</span><span>₩{{ quickCalcTotal.tax }}</span></div>
                <div class="flex justify-between text-xl font-bold border-t mt-2 pt-2"><span>實付:</span><span>₩{{ quickCalcTotal.final }}</span></div>
            </div>

            <div class="flex gap-2 mb-4">
                <button @click="addQuickItem" class="flex-1 bg-white border border-dashed border-gray-400 p-2 rounded-lg text-sm">+ 手動新增產品</button>
            </div>

            <div v-for="(item, idx) in quickItems" :key="idx" class="card flex items-center gap-3">
                <div class="flex-1">
                    <input v-model="item.name" placeholder="產品名稱" class="text-sm w-full font-bold mb-1">
                    <div class="flex gap-2">
                        <input v-model.number="item.price" type="number" placeholder="價格" class="text-xs border rounded px-2 w-24">
                        <input v-model.number="item.qty" type="number" placeholder="數量" class="text-xs border rounded px-2 w-16">
                    </div>
                </div>
                <button @click="quickItems.splice(idx, 1)" class="text-red-300"><i class="fas fa-trash"></i></button>
            </div>
        </section>
    </main>

    <div v-if="modals.plan" class="fixed inset-0 bg-black/50 z-[100] flex items-end">
        <div class="bg-white w-full rounded-t-3xl p-6 animate-slide-up">
            <h3 class="font-bold text-lg mb-4">加入計畫清單</h3>
            <label class="text-sm text-gray-500">選擇計畫</label>
            <select v-model="modals.selectedPlanId" class="input-field mb-4">
                <option v-for="p in plans" :value="p.id">{{ p.name }}</option>
            </select>
            <label class="text-sm text-gray-500">數量</label>
            <div class="flex items-center gap-4 mt-2 mb-6">
                <button @click="modals.qty > 1 ? modals.qty-- : null" class="w-10 h-10 border rounded-full text-xl">-</button>
                <span class="text-xl font-bold">{{ modals.qty }}</span>
                <button @click="modals.qty++" class="w-10 h-10 border rounded-full text-xl">+</button>
            </div>
            <div class="flex gap-3">
                <button @click="modals.plan = false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold">取消</button>
                <button @click="confirmAddToPlan" class="flex-1 py-3 bg-pink-500 text-white rounded-xl font-bold">確認加入</button>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            currentTab: 'register',
            tabs: [
                { id: 'register', name: '登記', icon: 'fas fa-plus-circle' },
                { id: 'library', name: '產品庫', icon: 'fas fa-th-large' },
                { id: 'plan', name: '計畫', icon: 'fas fa-list-check' },
                { id: 'quick', name: '速算', icon: 'fas fa-calculator' }
            ],
            categories: {
                '護膚品': ['化妝水', '精華', '乳液/面霜', '防曬', '潔面', '卸妝'],
                '化妝品Base': ['妝前', '氣墊', '粉底', '遮瑕', '腮紅', '光/陰影'],
                '化妝品Eyes': ['眉筆', '眼線/臥蠶', '眼影', '睫毛膏'],
                '化妝品Lip': ['唇線筆', '唇釉', '唇膏'],
                '其他': ['手部膚理', '身體護理', '香水', '零食', '生活雜貨']
            },
            form: { name: '', img: '', link: '', category: '', subCategory: '', specs: [] },
            products: [],
            plans: [{ id: Date.now(), name: '我的首個清單', items: [] }],
            quickItems: [],
            libraryFilter: '',
            searchQuery: '',
            modals: { plan: false, selectedPlanId: null, selectedProd: null, selectedSpec: null, qty: 1 }
        }
    },
    computed: {
        filteredProducts() {
            return this.products.filter(p => {
                const matchSearch = p.name.toLowerCase().includes(this.searchQuery.toLowerCase());
                const matchFilter = this.libraryFilter ? p.tag === this.libraryFilter : true;
                return matchSearch && matchFilter;
            });
        },
        quickCalcTotal() {
            const total = this.quickItems.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const tax = this.calculateTax(total);
            return { total, tax, final: total - tax };
        }
    },
    methods: {
        addSpec() {
            this.form.specs.push({ id: Date.now(), name: '', originalPrice: 0, salePrice: 0, saleStart: '', saleEnd: '', history: [] });
        },
        saveProduct() {
            if (!this.form.name) return alert('請填寫名稱');
            const newProduct = { ...this.form, id: Date.now(), tag: '未收藏' };
            this.products.push(newProduct);
            this.saveToStorage();
            alert('儲存成功！');
            this.form = { name: '', img: '', link: '', category: '', subCategory: '', specs: [] };
        },
        deleteProduct(id) {
            if(confirm('確定刪除？')) {
                this.products = this.products.filter(p => p.id !== id);
                this.saveToStorage();
            }
        },
        updateTag(prod, tag) {
            prod.tag = tag;
            this.saveToStorage();
        },
        toggleFilter(tag) {
            this.libraryFilter = this.libraryFilter === tag ? '' : tag;
        },
        openPlanModal(prod, spec) {
            this.modals.selectedProd = prod;
            this.modals.selectedSpec = spec;
            this.modals.selectedPlanId = this.plans[0]?.id;
            this.modals.qty = 1;
            this.modals.plan = true;
        },
        confirmAddToPlan() {
            const plan = this.plans.find(p => p.id === this.modals.selectedPlanId);
            if (plan) {
                plan.items.push({
                    id: Date.now(),
                    prodName: this.modals.selectedProd.name,
                    specName: this.modals.selectedSpec.name,
                    price: this.modals.selectedSpec.salePrice,
                    qty: this.modals.qty
                });
                this.saveToStorage();
            }
            this.modals.plan = false;
        },
        addPlan() {
            const name = prompt('計畫名稱：', '新計畫 ' + (this.plans.length + 1));
            if (name) this.plans.push({ id: Date.now(), name, items: [] });
            this.saveToStorage();
        },
        deletePlan(id) {
            this.plans = this.plans.filter(p => p.id !== id);
            this.saveToStorage();
        },
        addQuickItem() {
            this.quickItems.push({ name: '', price: 0, qty: 1 });
        },
        calculateTax(amount) {
            if (amount < 15000) return 0;
            if (amount < 30000) return 1000;
            if (amount < 50000) return 2000;
            if (amount < 75000) return 3000;
            if (amount < 100000) return 5000;
            if (amount < 125000) return 7000;
            if (amount < 150000) return 8000;
            if (amount < 175000) return 9000;
            if (amount < 200000) return 10000;
            if (amount < 225000) return 12000;
            if (amount < 250000) return 13000;
            if (amount < 275000) return 15000;
            if (amount < 300000) return 17000;
            if (amount < 325000) return 19000;
            if (amount < 350000) return 21000;
            if (amount < 375000) return 23000;
            if (amount < 400000) return 25000;
            if (amount < 425000) return 27000;
            if (amount < 450000) return 28000;
            if (amount < 475000) return 30000;
            if (amount < 500000) return 32000;
            if (amount < 550000) return 35000;
            if (amount < 600000) return 37000;
            return 41000;
        },
        calculatePlanTotal(plan) {
            const total = plan.items.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const tax = this.calculateTax(total);
            return { total, tax, final: total - tax };
        },
        saveToStorage() {
            localStorage.setItem('priceTrackerData', JSON.stringify({
                products: this.products,
                plans: this.plans
            }));
        },
        loadFromStorage() {
            const data = localStorage.getItem('priceTrackerData');
            if (data) {
                const parsed = JSON.parse(data);
                this.products = parsed.products || [];
                this.plans = parsed.plans || [];
            }
        },
        exportData() {
            const data = JSON.stringify({ products: this.products, plans: this.plans });
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `price_history_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        },
        importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = JSON.parse(e.target.result);
                this.products = data.products || [];
                this.plans = data.plans || [];
                this.saveToStorage();
                alert('匯入成功！');
            };
            reader.readAsText(file);
        },
        showHistory(prod, spec) {
            alert(`規格: ${spec.name}\n目前原價: ₩${spec.originalPrice}\n目前特價: ₩${spec.salePrice}\n期間: ${spec.saleStart} 至 ${spec.saleEnd}`);
        }
    },
    mounted() {
        this.loadFromStorage();
    }
}).mount('#app');
</script>

<style>
@keyframes slide-up {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}
.animate-slide-up {
    animation: slide-up 0.3s ease-out;
}
</style>

</body>
</html>
